name: Typescript - Publish

on:
  push:
    branches: [main]
    paths:
      - "typescript/package.json"
      - ".github/workflows/typescript-publish.yml"

jobs:
  publish:
    name: Build and publish to NPM
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: typescript
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: typescript/package-lock.json
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: npm ci
      - name: Build TypeScript package
        run: npm run build
      - name: Build CLI with local package
        run: |
          npm link
          cd ../cli && bun install && npm link @hpx7/delta-pack && bun run build && npm link
      - name: Run tests
        run: npm test
      - name: Publish to NPM
        uses: JS-DevTools/npm-publish@v4
        with:
          package: typescript/package.json
          access: public
          provenance: true

  docs:
    name: Publish docs to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: typescript
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: typescript/package-lock.json
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: npm ci
      - name: Build TypeScript package
        run: npm run build
      - name: Build CLI with local package
        run: |
          npm link
          cd ../cli && bun install && npm link @hpx7/delta-pack && bun run build && npm link
      - name: Generate code
        run: npm run test:gen && npm run bench:build
      - name: Generate docs
        run: npm run docs
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./typescript/docs
          destination_dir: typescript
          keep_files: true
