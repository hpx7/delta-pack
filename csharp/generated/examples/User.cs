// Auto-generated by DeltaPack - do not edit
using System.Linq;

namespace Generated.Examples
{
    public enum HairColor
    {
        BLACK = 0,
        BROWN = 1,
        BLOND = 2,
        RED = 3,
        WHITE = 4,
        OTHER = 5
    }

    public class Address
    {
        public string Street { get; set; } = "";
        public string Zip { get; set; } = "";
        public string State { get; set; } = "";

        public static Address Default() => new();

        public static Address FromJson(System.Text.Json.JsonElement json)
        {
            return new()
            {
                Street = DeltaPack.JsonHelpers.ParseString(json.GetProperty("street")),
                Zip = DeltaPack.JsonHelpers.ParseString(json.GetProperty("zip")),
                State = DeltaPack.JsonHelpers.ParseString(json.GetProperty("state")),
            };
        }

        public static System.Text.Json.Nodes.JsonObject ToJson(Address obj)
        {
            var result = new System.Text.Json.Nodes.JsonObject();
            result["street"] = obj.Street;
            result["zip"] = obj.Zip;
            result["state"] = obj.State;
            return result;
        }

        public static Address Clone(Address obj)
        {
            return new()
            {
                Street = obj.Street,
                Zip = obj.Zip,
                State = obj.State,
            };
        }

        public static bool Equals(Address a, Address b)
        {
            return a.Street == b.Street &&
                a.Zip == b.Zip &&
                a.State == b.State;
        }

        public static byte[] Encode(Address obj)
        {
            var encoder = new DeltaPack.Encoder();
            Encode_(obj, encoder);
            return encoder.ToBuffer();
        }

        internal static void Encode_(Address obj, DeltaPack.Encoder encoder)
        {
            encoder.PushString(obj.Street);
            encoder.PushString(obj.Zip);
            encoder.PushString(obj.State);
        }

        public static byte[] EncodeDiff(Address a, Address b)
        {
            var encoder = new DeltaPack.Encoder();
            EncodeDiff_(a, b, encoder);
            return encoder.ToBuffer();
        }

        internal static void EncodeDiff_(Address a, Address b, DeltaPack.Encoder encoder)
        {
            var changed = !Equals(a, b);
            encoder.PushBoolean(changed);
            if (!changed) return;
            EncodeDiffFields_(a, b, encoder);
        }

        internal static void EncodeDiffFields_(Address a, Address b, DeltaPack.Encoder encoder)
        {
            {
                var changed = !(a.Street == b.Street);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Street, b.Street);
            }
            {
                var changed = !(a.Zip == b.Zip);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Zip, b.Zip);
            }
            {
                var changed = !(a.State == b.State);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.State, b.State);
            }
        }

        public static Address Decode(byte[] buf)
        {
            var decoder = new DeltaPack.Decoder(buf);
            return Decode_(decoder);
        }

        internal static Address Decode_(DeltaPack.Decoder decoder)
        {
            return new()
            {
                Street = decoder.NextString(),
                Zip = decoder.NextString(),
                State = decoder.NextString(),
            };
        }

        public static Address DecodeDiff(Address obj, byte[] diff)
        {
            var decoder = new DeltaPack.Decoder(diff);
            return DecodeDiff_(obj, decoder);
        }

        internal static Address DecodeDiff_(Address obj, DeltaPack.Decoder decoder)
        {
            var changed = decoder.NextBoolean();
            if (!changed) return obj;
            return DecodeDiffFields_(obj, decoder);
        }

        internal static Address DecodeDiffFields_(Address obj, DeltaPack.Decoder decoder)
        {
            return new()
            {
                Street = decoder.NextFieldDiff(obj.Street, x => decoder.NextStringDiff(x)),
                Zip = decoder.NextFieldDiff(obj.Zip, x => decoder.NextStringDiff(x)),
                State = decoder.NextFieldDiff(obj.State, x => decoder.NextStringDiff(x)),
            };
        }
    }

    public class EmailContact : Contact
    {
        public override string Type => "EmailContact";

        public string Email { get; set; } = "";

        public static new EmailContact Default() => new();

        public static new EmailContact FromJson(System.Text.Json.JsonElement json)
        {
            return new()
            {
                Email = DeltaPack.JsonHelpers.ParseString(json.GetProperty("email")),
            };
        }

        public static System.Text.Json.Nodes.JsonObject ToJson(EmailContact obj)
        {
            var result = new System.Text.Json.Nodes.JsonObject();
            result["email"] = obj.Email;
            return result;
        }

        public static EmailContact Clone(EmailContact obj)
        {
            return new()
            {
                Email = obj.Email,
            };
        }

        public static bool Equals(EmailContact a, EmailContact b)
        {
            return a.Email == b.Email;
        }

        public static byte[] Encode(EmailContact obj)
        {
            var encoder = new DeltaPack.Encoder();
            Encode_(obj, encoder);
            return encoder.ToBuffer();
        }

        internal static void Encode_(EmailContact obj, DeltaPack.Encoder encoder)
        {
            encoder.PushString(obj.Email);
        }

        public static byte[] EncodeDiff(EmailContact a, EmailContact b)
        {
            var encoder = new DeltaPack.Encoder();
            EncodeDiff_(a, b, encoder);
            return encoder.ToBuffer();
        }

        internal static void EncodeDiff_(EmailContact a, EmailContact b, DeltaPack.Encoder encoder)
        {
            var changed = !Equals(a, b);
            encoder.PushBoolean(changed);
            if (!changed) return;
            EncodeDiffFields_(a, b, encoder);
        }

        internal static void EncodeDiffFields_(EmailContact a, EmailContact b, DeltaPack.Encoder encoder)
        {
            {
                var changed = !(a.Email == b.Email);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Email, b.Email);
            }
        }

        public static new EmailContact Decode(byte[] buf)
        {
            var decoder = new DeltaPack.Decoder(buf);
            return Decode_(decoder);
        }

        internal static new EmailContact Decode_(DeltaPack.Decoder decoder)
        {
            return new()
            {
                Email = decoder.NextString(),
            };
        }

        public static EmailContact DecodeDiff(EmailContact obj, byte[] diff)
        {
            var decoder = new DeltaPack.Decoder(diff);
            return DecodeDiff_(obj, decoder);
        }

        internal static EmailContact DecodeDiff_(EmailContact obj, DeltaPack.Decoder decoder)
        {
            var changed = decoder.NextBoolean();
            if (!changed) return obj;
            return DecodeDiffFields_(obj, decoder);
        }

        internal static EmailContact DecodeDiffFields_(EmailContact obj, DeltaPack.Decoder decoder)
        {
            return new()
            {
                Email = decoder.NextFieldDiff(obj.Email, x => decoder.NextStringDiff(x)),
            };
        }
    }

    public class PhoneContact : Contact
    {
        public override string Type => "PhoneContact";

        public string Phone { get; set; } = "";
        public long? Extension { get; set; }

        public static new PhoneContact Default() => new();

        public static new PhoneContact FromJson(System.Text.Json.JsonElement json)
        {
            return new()
            {
                Phone = DeltaPack.JsonHelpers.ParseString(json.GetProperty("phone")),
                Extension = json.TryGetProperty("extension", out var extensionEl) ? DeltaPack.JsonHelpers.IsNullOrEmpty(extensionEl) ? null : extensionEl.GetInt64() : null,
            };
        }

        public static System.Text.Json.Nodes.JsonObject ToJson(PhoneContact obj)
        {
            var result = new System.Text.Json.Nodes.JsonObject();
            result["phone"] = obj.Phone;
            if (obj.Extension.HasValue) result["extension"] = obj.Extension;
            return result;
        }

        public static PhoneContact Clone(PhoneContact obj)
        {
            return new()
            {
                Phone = obj.Phone,
                Extension = obj.Extension,
            };
        }

        public static bool Equals(PhoneContact a, PhoneContact b)
        {
            return a.Phone == b.Phone &&
                DeltaPack.EqualityHelpers.EqualsOptionalValue(a.Extension, b.Extension, (x, y) => x == y);
        }

        public static byte[] Encode(PhoneContact obj)
        {
            var encoder = new DeltaPack.Encoder();
            Encode_(obj, encoder);
            return encoder.ToBuffer();
        }

        internal static void Encode_(PhoneContact obj, DeltaPack.Encoder encoder)
        {
            encoder.PushString(obj.Phone);
            encoder.PushBoolean(obj.Extension.HasValue);
            if (obj.Extension.HasValue) encoder.PushBoundedInt(obj.Extension.Value, 0);
        }

        public static byte[] EncodeDiff(PhoneContact a, PhoneContact b)
        {
            var encoder = new DeltaPack.Encoder();
            EncodeDiff_(a, b, encoder);
            return encoder.ToBuffer();
        }

        internal static void EncodeDiff_(PhoneContact a, PhoneContact b, DeltaPack.Encoder encoder)
        {
            var changed = !Equals(a, b);
            encoder.PushBoolean(changed);
            if (!changed) return;
            EncodeDiffFields_(a, b, encoder);
        }

        internal static void EncodeDiffFields_(PhoneContact a, PhoneContact b, DeltaPack.Encoder encoder)
        {
            {
                var changed = !(a.Phone == b.Phone);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Phone, b.Phone);
            }
            {
                var changed = !(DeltaPack.EqualityHelpers.EqualsOptionalValue(a.Extension, b.Extension, (x, y) => x == y));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushOptionalDiff<long>(a.Extension, b.Extension, x => encoder.PushBoundedInt(x, 0), (x, y) => encoder.PushBoundedIntDiff(x, y, 0));
            }
        }

        public static new PhoneContact Decode(byte[] buf)
        {
            var decoder = new DeltaPack.Decoder(buf);
            return Decode_(decoder);
        }

        internal static new PhoneContact Decode_(DeltaPack.Decoder decoder)
        {
            return new()
            {
                Phone = decoder.NextString(),
                Extension = decoder.NextBoolean() ? (long?)decoder.NextBoundedInt(0) : null,
            };
        }

        public static PhoneContact DecodeDiff(PhoneContact obj, byte[] diff)
        {
            var decoder = new DeltaPack.Decoder(diff);
            return DecodeDiff_(obj, decoder);
        }

        internal static PhoneContact DecodeDiff_(PhoneContact obj, DeltaPack.Decoder decoder)
        {
            var changed = decoder.NextBoolean();
            if (!changed) return obj;
            return DecodeDiffFields_(obj, decoder);
        }

        internal static PhoneContact DecodeDiffFields_(PhoneContact obj, DeltaPack.Decoder decoder)
        {
            return new()
            {
                Phone = decoder.NextFieldDiff(obj.Phone, x => decoder.NextStringDiff(x)),
                Extension = decoder.NextFieldDiff(obj.Extension, x => decoder.NextOptionalDiff<long>(x, () => decoder.NextBoundedInt(0), x => decoder.NextBoundedIntDiff(x, 0))),
            };
        }
    }

    public abstract class Contact
    {
        public abstract string Type { get; }

        public static Contact Default() => EmailContact.Default();

        public static Contact FromJson(System.Text.Json.JsonElement json)
        {
            if (json.TryGetProperty("type", out var typeEl) && json.TryGetProperty("val", out var val))
            {
                var typeName = DeltaPack.JsonHelpers.FindVariant(typeEl.GetString()!, "EmailContact", "PhoneContact");
                if (typeName == "EmailContact") return EmailContact.FromJson(val);
                else if (typeName == "PhoneContact") return PhoneContact.FromJson(val);
                throw new System.InvalidOperationException($"Unknown Contact type: {typeEl.GetString()}");
            }
            var prop = json.EnumerateObject().FirstOrDefault();
            if (prop.Value.ValueKind != System.Text.Json.JsonValueKind.Undefined)
            {
                var typeName = DeltaPack.JsonHelpers.FindVariant(prop.Name, "EmailContact", "PhoneContact");
                var valProp = prop.Value;
                if (typeName == "EmailContact") return EmailContact.FromJson(valProp);
                else if (typeName == "PhoneContact") return PhoneContact.FromJson(valProp);
            }
            throw new System.InvalidOperationException("Invalid Contact format");
        }

        public static System.Text.Json.Nodes.JsonObject ToJson(Contact obj)
        {
            if (obj is EmailContact emailContact) return new System.Text.Json.Nodes.JsonObject { ["EmailContact"] = EmailContact.ToJson(emailContact) };
            else if (obj is PhoneContact phoneContact) return new System.Text.Json.Nodes.JsonObject { ["PhoneContact"] = PhoneContact.ToJson(phoneContact) };
            throw new System.InvalidOperationException($"Unknown Contact type: {obj.Type}");
        }

        public static Contact Clone(Contact obj)
        {
            if (obj is EmailContact emailContact) return EmailContact.Clone(emailContact);
            else if (obj is PhoneContact phoneContact) return PhoneContact.Clone(phoneContact);
            throw new System.InvalidOperationException($"Unknown Contact type: {obj.Type}");
        }

        public static bool Equals(Contact a, Contact b)
        {
            if (a.Type != b.Type) return false;
            if (a is EmailContact emailContactA && b is EmailContact emailContactB) return EmailContact.Equals(emailContactA, emailContactB);
            else if (a is PhoneContact phoneContactA && b is PhoneContact phoneContactB) return PhoneContact.Equals(phoneContactA, phoneContactB);
            return false;
        }

        public static byte[] Encode(Contact obj)
        {
            var encoder = new DeltaPack.Encoder();
            Encode_(obj, encoder);
            return encoder.ToBuffer();
        }

        internal static void Encode_(Contact obj, DeltaPack.Encoder encoder)
        {
            if (obj is EmailContact emailContact)
            {
                encoder.PushEnum(0, 1);
                EmailContact.Encode_(emailContact, encoder);
            }
            else if (obj is PhoneContact phoneContact)
            {
                encoder.PushEnum(1, 1);
                PhoneContact.Encode_(phoneContact, encoder);
            }
        }

        public static byte[] EncodeDiff(Contact a, Contact b)
        {
            var encoder = new DeltaPack.Encoder();
            EncodeDiff_(a, b, encoder);
            return encoder.ToBuffer();
        }

        internal static void EncodeDiff_(Contact a, Contact b, DeltaPack.Encoder encoder)
        {
            encoder.PushBoolean(a.Type == b.Type);
            if (b is EmailContact emailContactB)
            {
                if (a is EmailContact emailContactA)
                {
                    EmailContact.EncodeDiffFields_(emailContactA, emailContactB, encoder);
                }
                else
                {
                    encoder.PushEnum(0, 1);
                    EmailContact.Encode_(emailContactB, encoder);
                }
            }
            else if (b is PhoneContact phoneContactB)
            {
                if (a is PhoneContact phoneContactA)
                {
                    PhoneContact.EncodeDiffFields_(phoneContactA, phoneContactB, encoder);
                }
                else
                {
                    encoder.PushEnum(1, 1);
                    PhoneContact.Encode_(phoneContactB, encoder);
                }
            }
        }

        public static Contact Decode(byte[] buf)
        {
            var decoder = new DeltaPack.Decoder(buf);
            return Decode_(decoder);
        }

        internal static Contact Decode_(DeltaPack.Decoder decoder)
        {
            var type = decoder.NextEnum(1);
            if (type == 0) return EmailContact.Decode_(decoder);
            else if (type == 1) return PhoneContact.Decode_(decoder);
            throw new System.InvalidOperationException("Invalid Contact union");
        }

        public static Contact DecodeDiff(Contact obj, byte[] diff)
        {
            var decoder = new DeltaPack.Decoder(diff);
            return DecodeDiff_(obj, decoder);
        }

        internal static Contact DecodeDiff_(Contact obj, DeltaPack.Decoder decoder)
        {
            var isSameType = decoder.NextBoolean();
            if (isSameType)
            {
                if (obj is EmailContact emailContact) return EmailContact.DecodeDiffFields_(emailContact, decoder);
                else if (obj is PhoneContact phoneContact) return PhoneContact.DecodeDiffFields_(phoneContact, decoder);
                throw new System.InvalidOperationException("Invalid Contact diff");
            }
            else
            {
                var type = decoder.NextEnum(1);
                if (type == 0) return EmailContact.Decode_(decoder);
                else if (type == 1) return PhoneContact.Decode_(decoder);
                throw new System.InvalidOperationException("Invalid Contact diff");
            }
        }
    }

    public class User
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public long Age { get; set; }
        public float Weight { get; set; }
        public bool Married { get; set; }
        public HairColor HairColor { get; set; } = HairColor.BLACK;
        public Address? Address { get; set; }
        public System.Collections.Generic.List<User> Children { get; set; } = new System.Collections.Generic.List<User>();
        public System.Collections.Generic.Dictionary<string, string> Metadata { get; set; } = new System.Collections.Generic.Dictionary<string, string>();
        public Contact? PreferredContact { get; set; }

        public static User Default() => new();

        public static User FromJson(System.Text.Json.JsonElement json)
        {
            return new()
            {
                Id = DeltaPack.JsonHelpers.ParseString(json.GetProperty("id")),
                Name = DeltaPack.JsonHelpers.ParseString(json.GetProperty("name")),
                Age = json.GetProperty("age").GetInt64(),
                Weight = json.GetProperty("weight").GetSingle(),
                Married = DeltaPack.JsonHelpers.ParseBoolean(json.GetProperty("married")),
                HairColor = DeltaPack.JsonHelpers.ParseEnum<HairColor>(json.GetProperty("hairColor")),
                Address = json.TryGetProperty("address", out var addressEl) ? DeltaPack.JsonHelpers.IsNullOrEmpty(addressEl) ? null : Address.FromJson(addressEl) : null,
                Children = json.GetProperty("children").EnumerateArray().Select(x => User.FromJson(x)).ToList(),
                Metadata = json.GetProperty("metadata").EnumerateObject().ToDictionary(p => p.Name, p => DeltaPack.JsonHelpers.ParseString(p.Value)),
                PreferredContact = json.TryGetProperty("preferredContact", out var preferredContactEl) ? DeltaPack.JsonHelpers.IsNullOrEmpty(preferredContactEl) ? null : Contact.FromJson(preferredContactEl) : null,
            };
        }

        public static System.Text.Json.Nodes.JsonObject ToJson(User obj)
        {
            var result = new System.Text.Json.Nodes.JsonObject();
            result["id"] = obj.Id;
            result["name"] = obj.Name;
            result["age"] = obj.Age;
            result["weight"] = obj.Weight;
            result["married"] = obj.Married;
            result["hairColor"] = obj.HairColor.ToString();
            if (obj.Address != null) result["address"] = Address.ToJson(obj.Address);
            result["children"] = new System.Text.Json.Nodes.JsonArray(obj.Children.Select(x => (System.Text.Json.Nodes.JsonNode?)User.ToJson(x)).ToArray());
            result["metadata"] = new System.Text.Json.Nodes.JsonObject(obj.Metadata.Select(kvp => new System.Collections.Generic.KeyValuePair<string, System.Text.Json.Nodes.JsonNode?>(kvp.Key, kvp.Value)));
            if (obj.PreferredContact != null) result["preferredContact"] = Contact.ToJson(obj.PreferredContact);
            return result;
        }

        public static User Clone(User obj)
        {
            return new()
            {
                Id = obj.Id,
                Name = obj.Name,
                Age = obj.Age,
                Weight = obj.Weight,
                Married = obj.Married,
                HairColor = obj.HairColor,
                Address = obj.Address != null ? Address.Clone(obj.Address) : null,
                Children = obj.Children.Select(x => User.Clone(x)).ToList(),
                Metadata = new System.Collections.Generic.Dictionary<string, string>(obj.Metadata),
                PreferredContact = obj.PreferredContact != null ? Contact.Clone(obj.PreferredContact) : null,
            };
        }

        public static bool Equals(User a, User b)
        {
            return a.Id == b.Id &&
                a.Name == b.Name &&
                a.Age == b.Age &&
                DeltaPack.EqualityHelpers.EqualsFloat(a.Weight, b.Weight) &&
                a.Married == b.Married &&
                a.HairColor == b.HairColor &&
                DeltaPack.EqualityHelpers.EqualsOptional(a.Address, b.Address, (x, y) => Generated.Examples.Address.Equals(x, y)) &&
                a.Children.Count == b.Children.Count && a.Children.Zip(b.Children).All(pair => User.Equals(pair.First, pair.Second)) &&
                a.Metadata.Count == b.Metadata.Count && a.Metadata.All(kvp => b.Metadata.TryGetValue(kvp.Key, out var v) && kvp.Value == v) &&
                DeltaPack.EqualityHelpers.EqualsOptional(a.PreferredContact, b.PreferredContact, (x, y) => Contact.Equals(x, y));
        }

        public static byte[] Encode(User obj)
        {
            var encoder = new DeltaPack.Encoder();
            Encode_(obj, encoder);
            return encoder.ToBuffer();
        }

        internal static void Encode_(User obj, DeltaPack.Encoder encoder)
        {
            encoder.PushString(obj.Id);
            encoder.PushString(obj.Name);
            encoder.PushBoundedInt(obj.Age, 0);
            encoder.PushFloat(obj.Weight);
            encoder.PushBoolean(obj.Married);
            encoder.PushEnum((int)obj.HairColor, 3);
            encoder.PushOptional(obj.Address, x => Generated.Examples.Address.Encode_(x, encoder));
            encoder.PushArray(obj.Children, x => User.Encode_(x, encoder));
            encoder.PushRecord(obj.Metadata, x => encoder.PushString(x), x => encoder.PushString(x));
            encoder.PushOptional(obj.PreferredContact, x => Contact.Encode_(x, encoder));
        }

        public static byte[] EncodeDiff(User a, User b)
        {
            var encoder = new DeltaPack.Encoder();
            EncodeDiff_(a, b, encoder);
            return encoder.ToBuffer();
        }

        internal static void EncodeDiff_(User a, User b, DeltaPack.Encoder encoder)
        {
            var changed = !Equals(a, b);
            encoder.PushBoolean(changed);
            if (!changed) return;
            EncodeDiffFields_(a, b, encoder);
        }

        internal static void EncodeDiffFields_(User a, User b, DeltaPack.Encoder encoder)
        {
            {
                var changed = !(a.Id == b.Id);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Id, b.Id);
            }
            {
                var changed = !(a.Name == b.Name);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushStringDiff(a.Name, b.Name);
            }
            {
                var changed = !(a.Age == b.Age);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushBoundedIntDiff(a.Age, b.Age, 0);
            }
            {
                var changed = !(DeltaPack.EqualityHelpers.EqualsFloat(a.Weight, b.Weight));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushFloatDiff(a.Weight, b.Weight);
            }
            encoder.PushBooleanDiff(a.Married, b.Married);
            {
                var changed = !(a.HairColor == b.HairColor);
                encoder.PushBoolean(changed);
                if (changed) encoder.PushEnumDiff((int)a.HairColor, (int)b.HairColor, 3);
            }
            {
                var changed = !(DeltaPack.EqualityHelpers.EqualsOptional(a.Address, b.Address, (x, y) => Generated.Examples.Address.Equals(x, y)));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushOptionalDiff<Address>(a.Address, b.Address, x => Generated.Examples.Address.Encode_(x, encoder), (x, y) => Generated.Examples.Address.EncodeDiffFields_(x, y, encoder));
            }
            {
                var changed = !(a.Children.Count == b.Children.Count && a.Children.Zip(b.Children).All(pair => User.Equals(pair.First, pair.Second)));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushArrayDiff<User>(a.Children, b.Children, (x, y) => User.Equals(x, y), x => User.Encode_(x, encoder), (x, y) => User.EncodeDiffFields_(x, y, encoder));
            }
            {
                var changed = !(a.Metadata.Count == b.Metadata.Count && a.Metadata.All(kvp => b.Metadata.TryGetValue(kvp.Key, out var v) && kvp.Value == v));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushRecordDiff<string, string>(a.Metadata, b.Metadata, (x, y) => x == y, x => encoder.PushString(x), x => encoder.PushString(x), (x, y) => encoder.PushStringDiff(x, y));
            }
            {
                var changed = !(DeltaPack.EqualityHelpers.EqualsOptional(a.PreferredContact, b.PreferredContact, (x, y) => Contact.Equals(x, y)));
                encoder.PushBoolean(changed);
                if (changed) encoder.PushOptionalDiff<Contact>(a.PreferredContact, b.PreferredContact, x => Contact.Encode_(x, encoder), (x, y) => Contact.EncodeDiff_(x, y, encoder));
            }
        }

        public static User Decode(byte[] buf)
        {
            var decoder = new DeltaPack.Decoder(buf);
            return Decode_(decoder);
        }

        internal static User Decode_(DeltaPack.Decoder decoder)
        {
            return new()
            {
                Id = decoder.NextString(),
                Name = decoder.NextString(),
                Age = decoder.NextBoundedInt(0),
                Weight = decoder.NextFloat(),
                Married = decoder.NextBoolean(),
                HairColor = (HairColor)decoder.NextEnum(3),
                Address = decoder.NextOptional(() => Generated.Examples.Address.Decode_(decoder)),
                Children = decoder.NextArray(() => User.Decode_(decoder)),
                Metadata = decoder.NextRecord(() => decoder.NextString(), () => decoder.NextString()),
                PreferredContact = decoder.NextOptional(() => Contact.Decode_(decoder)),
            };
        }

        public static User DecodeDiff(User obj, byte[] diff)
        {
            var decoder = new DeltaPack.Decoder(diff);
            return DecodeDiff_(obj, decoder);
        }

        internal static User DecodeDiff_(User obj, DeltaPack.Decoder decoder)
        {
            var changed = decoder.NextBoolean();
            if (!changed) return obj;
            return DecodeDiffFields_(obj, decoder);
        }

        internal static User DecodeDiffFields_(User obj, DeltaPack.Decoder decoder)
        {
            return new()
            {
                Id = decoder.NextFieldDiff(obj.Id, x => decoder.NextStringDiff(x)),
                Name = decoder.NextFieldDiff(obj.Name, x => decoder.NextStringDiff(x)),
                Age = decoder.NextFieldDiff(obj.Age, x => decoder.NextBoundedIntDiff(x, 0)),
                Weight = decoder.NextFieldDiff(obj.Weight, x => decoder.NextFloatDiff(x)),
                Married = decoder.NextBooleanDiff(obj.Married),
                HairColor = decoder.NextFieldDiff(obj.HairColor, x => (HairColor)decoder.NextEnumDiff((int)x, 3)),
                Address = decoder.NextFieldDiff(obj.Address, x => decoder.NextOptionalDiff<Address>(x, () => Generated.Examples.Address.Decode_(decoder), x => Generated.Examples.Address.DecodeDiffFields_(x, decoder))),
                Children = decoder.NextFieldDiff(obj.Children, x => decoder.NextArrayDiff<User>(x, () => User.Decode_(decoder), x => User.DecodeDiffFields_(x, decoder))),
                Metadata = decoder.NextFieldDiff(obj.Metadata, x => decoder.NextRecordDiff<string, string>(x, () => decoder.NextString(), () => decoder.NextString(), x => decoder.NextStringDiff(x))),
                PreferredContact = decoder.NextFieldDiff(obj.PreferredContact, x => decoder.NextOptionalDiff<Contact>(x, () => Contact.Decode_(decoder), x => Contact.DecodeDiff_(x, decoder))),
            };
        }
    }
}
